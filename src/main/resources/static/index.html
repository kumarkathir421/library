<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<title>üìö Library Management UI</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
	<style>
		body {
			background-color: #f8f9fa;
		}

		h2 {
			margin-top: 1rem;
		}

		.card {
			border-radius: 10px;
			box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
		}

		table {
			font-size: 0.9rem;
		}

		.toast-container {
			z-index: 2000;
		}
	</style>
</head>

<body>
	<div class="container py-4">
		<h2 class="text-center mb-4 text-primary fw-bold">üìö Library Management Dashboard</h2>

		<!-- üîî Toast Notification Container -->
		<div class="position-fixed top-0 end-0 p-3 toast-container">
			<div id="toastBox"></div>
		</div>

		<!-- üë§ Register Borrower -->
		<div class="card mb-3">
			<div class="card-body">
				<h5 class="card-title text-secondary">üë§ Register Borrower</h5>
				<div class="row g-2">
					<div class="col-md-5">
						<input type="text" id="borrowerName" class="form-control" placeholder="Borrower Name">
					</div>
					<div class="col-md-5">
						<input type="email" id="borrowerEmail" class="form-control" placeholder="Borrower Email">
					</div>
					<div class="col-md-2">
						<button class="btn btn-primary w-100" onclick="registerBorrower()">Register</button>
					</div>
				</div>
			</div>
		</div>

		<!-- üßæ Borrowers List -->
		<div class="card mb-3">
			<div class="card-body">
				<h5 class="card-title text-secondary d-flex justify-content-between align-items-center">
					üßæ Borrowers List
					<button class="btn btn-outline-info btn-sm" onclick="getAllBorrowers()">Refresh</button>
				</h5>
				<table class="table table-striped table-hover align-middle">
					<thead class="table-dark">
						<tr>
							<th>Code</th>
							<th>Name</th>
							<th>Email</th>
						</tr>
					</thead>
					<tbody id="borrowersTable"></tbody>
				</table>
			</div>
		</div>

		<!-- üìñ Register Book -->
		<div class="card mb-3">
			<div class="card-body">
				<h5 class="card-title text-secondary">üìñ Register Book</h5>
				<div class="row g-2">
					<div class="col-md-3">
						<input type="text" id="bookIsbn" class="form-control" placeholder="ISBN Number">
					</div>
					<div class="col-md-4">
						<input type="text" id="bookTitle" class="form-control" placeholder="Book Title">
					</div>
					<div class="col-md-3">
						<input type="text" id="bookAuthor" class="form-control" placeholder="Author Name">
					</div>
					<div class="col-md-2">
						<button class="btn btn-success w-100" onclick="registerBook()">Add Book</button>
					</div>
				</div>
			</div>
		</div>

		<!-- üìö Books List -->
		<div class="card mb-3">
			<div class="card-body">
				<h5 class="card-title text-secondary d-flex justify-content-between align-items-center">
					üìò Books List
					<button class="btn btn-outline-info btn-sm" onclick="getAllBooks()">Refresh</button>
				</h5>
				<table class="table table-striped table-hover align-middle">
					<thead class="table-dark">
						<tr>
							<th>Code</th>
							<th>ISBN</th>
							<th>Title</th>
							<th>Author</th>
							<th>Status</th>
							<th>Borrower Code</th>
						</tr>
					</thead>
					<tbody id="booksTable"></tbody>
				</table>
			</div>
		</div>

		<!-- üîÅ Borrow / Return -->
		<div class="card mb-3">
			<div class="card-body">
				<h5 class="card-title text-secondary">üîÅ Borrow / Return Book</h5>
				<div class="row g-2 align-items-center">
					<div class="col-md-4">
						<select id="borrowerSelect" class="form-select">
							<option value="">Select Borrower</option>
						</select>
					</div>
					<div class="col-md-4">
						<select id="bookSelect" class="form-select">
							<option value="">Select Book</option>
						</select>
					</div>
					<div class="col-md-4 d-flex gap-2">
						<button class="btn btn-warning w-100" onclick="borrowBook()">Borrow</button>
						<button class="btn btn-secondary w-100" onclick="returnBook()">Return</button>
					</div>
				</div>
				<div class="text-end mt-3">
					<button class="btn btn-danger btn-sm" onclick="doubleBorrow()">Test Double Borrow üö´</button>
				</div>
			</div>
		</div>

		<!-- üßæ Borrow History -->
		<div class="card mb-3">
			<div class="card-body">
				<h5 class="card-title text-secondary d-flex justify-content-between align-items-center">
					üïì Borrowed Book History
					<button class="btn btn-outline-info btn-sm" onclick="getBorrowHistory()">Refresh</button>
				</h5>
				<table class="table table-striped table-hover align-middle">
					<thead class="table-dark">
						<tr>
							<th>Book Code</th>
							<th>Title</th>
							<th>Borrower</th>
							<th>Borrow Date</th>
							<th>Return Date</th>
							<th>Status</th>
						</tr>
					</thead>
					<tbody id="historyTable"></tbody>
				</table>
			</div>
		</div>

	</div>

	<script>
		const API_BASE = "http://localhost:8080/api";

		// Notification
		function showAlert(message, type = 'success') {
			const toastBox = document.getElementById('toastBox');
			const bgClass =
				type === 'success' ? 'bg-success' :
					type === 'danger' ? 'bg-danger' :
						type === 'warning' ? 'bg-warning text-dark' :
							'bg-info';

			const toast = document.createElement('div');
			toast.className = `toast align-items-center text-white ${bgClass} border-0 show mb-2`;
			toast.role = "alert";
			toast.innerHTML = `
      <div class="d-flex">
        <div class="toast-body fw-semibold">${message}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    `;

			toastBox.appendChild(toast);
			setTimeout(() => {
				toast.classList.remove('show');
				setTimeout(() => toast.remove(), 300);
			}, 4000);
		}

		// Register Borrower
		async function registerBorrower() {
			const name = document.getElementById("borrowerName").value.trim();
			const email = document.getElementById("borrowerEmail").value.trim();
			if (!name || !email) return showAlert("Enter both name and email!", "warning");

			const res = await fetch(`${API_BASE}/borrowers`, {
				method: "POST",
				headers: {"Content-Type": "application/json"},
				body: JSON.stringify({name, email})
			});

			if (res.ok) {
				const data = await res.json();
				showAlert(`Borrower Registered ‚úÖ (${data.code})`, "success");
				getAllBorrowers();
			} else {
				const msg = await res.text();
				showAlert(msg || "Failed to register borrower", "danger");
			}

			document.getElementById("borrowerName").value = '';
			document.getElementById("borrowerEmail").value = '';
		}

		// Get All Borrowers
		async function getAllBorrowers() {
			const res = await fetch(`${API_BASE}/borrowers`);
			if (!res.ok) {
				return showAlert("Failed to load borrowers", "danger");
			}
			const data = await res.json();

			// Update borrower table
			const table = document.getElementById("borrowersTable");
			table.innerHTML = data.map(b => `
      <tr>
        <td>${b.code}</td>
        <td>${b.name}</td>
        <td>${b.email}</td>
      </tr>
    `).join('');

			// Update borrower dropdown
			const select = document.getElementById("borrowerSelect");
			select.innerHTML = '<option value="">Select Borrower</option>' +
				data.map(b => `<option value="${b.code}">${b.code} - ${b.name}</option>`).join('');
		}

		// Register Book
		async function registerBook() {
			const isbn = document.getElementById("bookIsbn").value.trim();
			const title = document.getElementById("bookTitle").value.trim();
			const author = document.getElementById("bookAuthor").value.trim();

			if (!isbn || !title || !author)
				return showAlert("Enter ISBN, title, and author!", "warning");

			const res = await fetch(`${API_BASE}/books`, {
				method: "POST",
				headers: {"Content-Type": "application/json"},
				body: JSON.stringify({isbn, title, author})
			});

			if (res.ok) {
				const data = await res.json();
				showAlert(`Book Added ‚úÖ (${data.code})`, "success");
				getAllBooks();
			} else {
				const msg = await res.text();
				showAlert(msg || "Failed to register book", "danger");
			}

			document.getElementById("bookIsbn").value = '';
			document.getElementById("bookTitle").value = '';
			document.getElementById("bookAuthor").value = '';
		}

		// Get All Books
		async function getAllBooks() {
			const res = await fetch(`${API_BASE}/books`);
			const data = await res.json();
			const table = document.getElementById("booksTable");

			table.innerHTML = data.map(b => `
      <tr>
        <td>${b.code}</td>
        <td>${b.isbn}</td>
        <td>${b.title}</td>
        <td>${b.author}</td>
        <td>${b.borrowedById ? '<span class="badge bg-danger">Borrowed</span>' : '<span class="badge bg-success">Available</span>'}</td>
        <td>${b.borrowedByCode || '-'}</td> <!-- ‚úÖ Updated -->
      </tr>
    `).join('');

			// Update book dropdown
			const select = document.getElementById("bookSelect");
			select.innerHTML = '<option value="">Select Book</option>' +
				data.map(b => `<option value="${b.code}">${b.code} - ${b.title}</option>`).join('');
		}

		// Borrow Book
		async function borrowBook() {
			const borrowerSelect = document.getElementById("borrowerSelect");
			const bookSelect = document.getElementById("bookSelect");

			const borrowerOption = borrowerSelect.options[borrowerSelect.selectedIndex].text;
			const bookOption = bookSelect.options[bookSelect.selectedIndex].text;

			const borrowerCode = borrowerOption.split(" - ")[0];
			const bookCode = bookOption.split(" - ")[0];

			if (!borrowerCode || !bookCode) return showAlert("Select borrower and book!", "warning");

			const res = await fetch(`${API_BASE}/books/borrow/${bookCode}?borrowerCode=${borrowerCode}`, {method: "POST"});
			const msg = await res.text();

			showAlert(msg, res.ok ? "info" : "danger");
			getAllBooks();
		}

		// Return Book
		async function returnBook() {
			const bookSelect = document.getElementById("bookSelect");
			const bookOption = bookSelect.options[bookSelect.selectedIndex].text;

			const bookCode = bookOption.split(" - ")[0];
			if (!bookCode) return showAlert("Select a book!", "warning");

			const res = await fetch(`${API_BASE}/books/return/${bookCode}`, {method: "POST"});
			const msg = await res.text();

			showAlert(msg, res.ok ? "secondary" : "danger");
			getAllBooks();
		}

		// Get Borrow History
		async function getBorrowHistory() {
			const res = await fetch(`${API_BASE}/history`);
			const data = await res.json();
			const table = document.getElementById("historyTable");

			table.innerHTML = data.map(h => `
      <tr>
        <td>${h.bookCode}</td>
        <td>${h.bookTitle}</td>
        <td>${h.borrowerCode} - ${h.borrowerName}</td>
        <td>${h.borrowDate ? new Date(h.borrowDate).toLocaleString() : '-'}</td>
        <td>${h.returnDate ? new Date(h.returnDate).toLocaleString() : '-'}</td>
        <td>
          ${h.status === 'BORROWED'
					? '<span class="badge bg-danger">Borrowed</span>'
					: '<span class="badge bg-success">Returned</span>'}
        </td>
      </tr>
    `).join('');
		}

		// Double Borrow Test
		async function doubleBorrow() {
			await borrowBook();
			await borrowBook();
		}

		// Load on start
		window.onload = () => {
			getAllBooks();
			getAllBorrowers();
			getBorrowHistory();
		};

	</script>

	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>